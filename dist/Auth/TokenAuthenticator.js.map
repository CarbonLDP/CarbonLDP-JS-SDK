{"version":3,"sources":["Auth/TokenAuthenticator.ts"],"names":[],"mappings":"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","file":"Auth/TokenAuthenticator.js","sourcesContent":["import Context from \"./../Context\";\nimport * as Errors from \"./../Errors\";\nimport * as HTTP from \"./../HTTP\";\nimport * as NS from \"./../NS\";\nimport * as ObjectSchema from \"./../ObjectSchema\";\nimport * as RDF from \"./../RDF\";\nimport * as Utils from \"./../Utils\";\n\nimport Authenticator from \"./Authenticator\";\nimport AuthenticationToken from \"./AuthenticationToken\";\nimport BasicAuthenticator from \"./BasicAuthenticator\";\nimport UsernameAndPasswordToken from \"./UsernameAndPasswordToken\";\nimport * as Token from \"./Token\";\nimport * as TokenCredentials from \"./TokenCredentials\";\nimport * as Credentials from \"./Credentials\";\n\nexport class Class implements Authenticator<UsernameAndPasswordToken> {\n\tprivate static TOKEN_CONTAINER:string = \"auth-tokens/\";\n\n\tprivate context:Context;\n\tprivate basicAuthenticator:BasicAuthenticator;\n\tprivate credentials:TokenCredentials.Class;\n\n\tconstructor( context:Context ) {\n\t\tif( context === null ) throw new Errors.IllegalArgumentError( \"context cannot be null\" );\n\n\t\tthis.context = context;\n\t\tthis.basicAuthenticator = new BasicAuthenticator();\n\t}\n\n\tisAuthenticated():boolean {\n\t\treturn !! this.credentials && this.credentials.token.expirationTime > new Date();\n\t}\n\n\tauthenticate( authenticationToken:UsernameAndPasswordToken ):Promise<TokenCredentials.Class> {\n\t\treturn this.basicAuthenticator.authenticate( authenticationToken ).then(\n\t\t\t( credentials:Credentials.Class ):Promise<[ Token.Class, HTTP.Response.Class ]> => {\n\t\t\t\treturn this.createToken();\n\t\t\t}\n\t\t).then(\n\t\t\t( [ token, response ]:[ Token.Class, HTTP.Response.Class ] ):TokenCredentials.Class => {\n\t\t\t\tthis.credentials = new TokenCredentials.Class( token );\n\n\t\t\t\tthis.basicAuthenticator.clearAuthentication();\n\n\t\t\t\treturn this.credentials;\n\t\t\t}\n\t\t);\n\t}\n\n\taddAuthentication( requestOptions:HTTP.Request.Options ):HTTP.Request.Options {\n\t\tlet headers:Map<string, HTTP.Header.Class> = requestOptions.headers ? requestOptions.headers : requestOptions.headers = new Map<string, HTTP.Header.Class>();\n\n\t\tthis.addTokenAuthenticationHeader( headers );\n\n\t\treturn requestOptions;\n\t}\n\n\tclearAuthentication():void {\n\t\tthis.credentials = null;\n\t}\n\n\tsupports( authenticationToken:AuthenticationToken ):boolean {\n\t\treturn authenticationToken instanceof UsernameAndPasswordToken;\n\t}\n\n\tprivate createToken():Promise<[ Token.Class, HTTP.Response.Class ]> {\n\t\tlet uri:string = this.context.resolve( Class.TOKEN_CONTAINER );\n\t\tlet requestOptions:HTTP.Request.Options = {};\n\n\t\tthis.basicAuthenticator.addAuthentication( requestOptions );\n\n\t\tHTTP.Request.Util.setAcceptHeader( \"application/ld+json\", requestOptions );\n\t\tHTTP.Request.Util.setPreferredInteractionModel( NS.LDP.Class.RDFSource, requestOptions );\n\n\t\treturn HTTP.Request.Service.post( uri, null, requestOptions, new HTTP.JSONLDParser.Class() ).then( ( [ expandedResult, response ]:[ Object, HTTP.Response.Class ] ) => {\n\t\t\tlet expandedNodes:RDF.Node.Class[] = RDF.Document.Util.getResources( expandedResult );\n\n\t\t\texpandedNodes = expandedNodes.filter( Token.Factory.hasRDFClass );\n\n\t\t\tif( expandedNodes.length === 0 ) throw new HTTP.Errors.BadResponseError( \"No '\" + Token.RDF_CLASS + \"' was returned.\", response );\n\t\t\tif( expandedNodes.length > 1 ) throw new HTTP.Errors.BadResponseError( \"Multiple '\" + Token.RDF_CLASS + \"' were returned. \", response );\n\n\t\t\tlet expandedToken:RDF.Node.Class = expandedNodes[ 0 ];\n\t\t\tlet token:Token.Class = Token.Factory.decorate( {} );\n\n\t\t\tlet digestedSchema:ObjectSchema.DigestedObjectSchema = this.context.documents.getSchemaFor( expandedToken );\n\n\t\t\tthis.context.documents.jsonldConverter.compact( expandedToken, token, digestedSchema, this.context.documents );\n\n\t\t\treturn [ token, response ];\n\t\t} );\n\t}\n\n\tprivate addTokenAuthenticationHeader( headers:Map<string, HTTP.Header.Class> ):Map<string, HTTP.Header.Class> {\n\t\tlet header:HTTP.Header.Class;\n\t\tif( headers.has( \"Authorization\" ) ) {\n\t\t\theader = headers.get( \"Authorization\" );\n\t\t} else {\n\t\t\theader = new HTTP.Header.Class();\n\t\t\theaders.set( \"Authorization\", header );\n\t\t}\n\t\tlet authorization:string = \"Token \" + this.credentials.token.key;\n\t\theader.values.push( new HTTP.Header.Value( authorization ) );\n\n\t\treturn headers;\n\t}\n}\n\nexport default Class;\n"],"sourceRoot":"/source/"}