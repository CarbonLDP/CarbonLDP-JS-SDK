{"version":3,"sources":["Auth/TokenAuthenticator.ts"],"names":[],"mappings":"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","file":"TokenAuthenticator.js","sourcesContent":["import * as Errors from \"../Errors\";\nimport { FreeResources } from \"../FreeResources\";\nimport { RequestUtils } from \"../HTTP\";\nimport { BadResponseError } from \"../HTTP/Errors\";\nimport { Header } from \"../HTTP/Header\";\nimport { RequestOptions } from \"../HTTP/Request\";\nimport { Response } from \"../HTTP/Response\";\nimport { ResponseMetadata } from \"../LDP\";\nimport { RDFNode } from \"../RDF/Node\";\nimport { promiseMethod } from \"../Utils\";\nimport { CS } from \"../Vocabularies\";\nimport { AuthenticatedUserInformationAccessor } from \"./AuthenticatedUserInformationAccessor\";\nimport { Authenticator } from \"./Authenticator\";\nimport { BasicAuthenticator } from \"./BasicAuthenticator\";\nimport {\n\tTokenCredentials,\n\tTokenCredentialsBase,\n} from \"./TokenCredentials\";\nimport { UsernameAndPasswordToken } from \"./UsernameAndPasswordToken\";\n\n\nexport class TokenAuthenticator extends Authenticator<UsernameAndPasswordToken, TokenCredentials> {\n\n\tprotected credentials:TokenCredentials;\n\n\tisAuthenticated():boolean {\n\t\treturn super.isAuthenticated() && this.credentials.expires > new Date();\n\t}\n\n\tauthenticate( tokenOrCredentials:UsernameAndPasswordToken | TokenCredentialsBase ):Promise<TokenCredentials> {\n\t\tif( TokenCredentialsBase.is( tokenOrCredentials ) )\n\t\t\treturn this._parseCredentialsBase( tokenOrCredentials );\n\n\t\treturn this._getCredentials( tokenOrCredentials );\n\t}\n\n\tprotected _getHeaderValue():string {\n\t\treturn \"Token \" + this.credentials.token;\n\t}\n\n\tprotected _parseCredentialsBase( credentialsBase:TokenCredentialsBase ):Promise<TokenCredentials> {\n\t\treturn promiseMethod( () => {\n\t\t\tconst credentials:TokenCredentials = TokenCredentials.createFrom( credentialsBase );\n\n\t\t\tif( credentials.expires <= new Date() ) throw new Errors.IllegalArgumentError( \"The token has already expired.\" );\n\n\t\t\treturn this.credentials = credentials;\n\t\t} );\n\t}\n\n\tprotected _getCredentials( token:UsernameAndPasswordToken ):Promise<TokenCredentials> {\n\t\tconst basicAuthenticator:BasicAuthenticator = new BasicAuthenticator( this.context );\n\t\treturn basicAuthenticator\n\t\t\t.authenticate( token )\n\t\t\t.then( () => {\n\t\t\t\tconst requestOptions:RequestOptions = {};\n\t\t\t\tbasicAuthenticator.addAuthentication( requestOptions );\n\n\t\t\t\tRequestUtils.setRetrievalPreferences( { include: [ CS.PreferAuthToken ] }, requestOptions );\n\n\t\t\t\treturn this.getAuthenticatedUser( requestOptions );\n\t\t\t} )\n\t\t\t.then( () => {\n\t\t\t\treturn this.credentials;\n\t\t\t} );\n\t}\n\n\tprotected _parseRDFMetadata( rdfData:object[], response:Response, requestOptions:RequestOptions ):AuthenticatedUserInformationAccessor {\n\t\tconst accessor:AuthenticatedUserInformationAccessor = super._parseRDFMetadata( rdfData, response );\n\n\t\tconst authTokenPrefer:string = `include=\"${ CS.PreferAuthToken }\"`;\n\n\t\tconst prefer:Header = requestOptions.headers && requestOptions.headers.get( \"prefer\" );\n\t\tif( ! prefer || ! prefer.hasValue( authTokenPrefer ) ) return accessor;\n\n\t\tconst preference:Header = response.getHeader( \"preference-applied\" );\n\t\tif( ! preference || ! preference.hasValue( authTokenPrefer ) )\n\t\t\tthrow new BadResponseError( `Preference \"${ authTokenPrefer }\" was not applied.`, response );\n\n\t\tthis._parseRDFCredentials( rdfData, response );\n\n\t\treturn accessor;\n\t}\n\n\tprotected _parseRDFCredentials( rdfData:object[], response:Response ):TokenCredentials {\n\t\tconst freeNodes:RDFNode[] = RDFNode.getFreeNodes( rdfData );\n\n\t\tconst freeResources:FreeResources = this.context.documents\n\t\t\t._getFreeResources( freeNodes );\n\n\t\tconst responseMetadata:ResponseMetadata = freeResources\n\t\t\t.getResources()\n\t\t\t.find( ResponseMetadata.is );\n\t\tif( ! responseMetadata ) throw new BadResponseError( `No \"${ ResponseMetadata.TYPE }\" was returned.`, response );\n\n\t\tconst tokenCredentials:TokenCredentials = responseMetadata.authToken;\n\t\tif( ! tokenCredentials ) throw new BadResponseError( `No \"${ TokenCredentials.TYPE }\" was returned.`, response );\n\n\t\treturn this.credentials = tokenCredentials;\n\t}\n\n}\n"]}