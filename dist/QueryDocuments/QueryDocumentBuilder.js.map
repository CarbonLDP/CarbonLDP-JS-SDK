{"version":3,"sources":["QueryDocuments/QueryDocumentBuilder.ts"],"names":[],"mappings":"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","file":"QueryDocumentBuilder.js","sourcesContent":["import {\n\tFilterToken,\n\tIRIToken,\n\tLiteralToken,\n\tPredicateToken,\n\tPrefixedNameToken,\n\tSubjectToken,\n\tTermToken,\n\tValuesToken,\n} from \"sparqler/tokens\";\n\nimport { IllegalArgumentError } from \"../Errors/IllegalArgumentError\";\nimport { IllegalStateError } from \"../Errors/IllegalStateError\";\n\nimport { DigestedObjectSchema } from \"../ObjectSchema/DigestedObjectSchema\";\nimport { DigestedObjectSchemaProperty } from \"../ObjectSchema/DigestedObjectSchemaProperty\";\nimport { ObjectSchemaDigester } from \"../ObjectSchema/ObjectSchemaDigester\";\nimport { ObjectSchemaProperty } from \"../ObjectSchema/ObjectSchemaProperty\";\n\nimport { Pointer } from \"../Pointer/Pointer\";\n\nimport { isObject } from \"../Utils\";\n\nimport { QueryContextBuilder } from \"./QueryContextBuilder\";\nimport { QueryObject } from \"./QueryObject\";\nimport { QueryProperty, QueryPropertyType } from \"./QueryProperty\";\nimport { QuerySchema } from \"./QuerySchema\";\nimport { QuerySchemaProperty } from \"./QuerySchemaProperty\";\nimport { QueryValue } from \"./QueryValue\";\nimport { _createPropertyPatterns, _getParentPath } from \"./Utils\";\n\n\nconst INHERIT:Readonly<{}> = Object.freeze( {} );\n\nexport class QueryDocumentBuilder {\n\tstatic readonly ALL:Readonly<{}> = Object.freeze( {} );\n\n\tinherit:Readonly<{}> = INHERIT;\n\tall:Readonly<{}> = QueryDocumentBuilder.ALL;\n\n\treadonly _context:QueryContextBuilder;\n\n\tprotected _document:QueryProperty;\n\n\tprivate _typesTriple:SubjectToken;\n\tprivate _values:ValuesToken;\n\n\tprivate _schema:DigestedObjectSchema;\n\n\tconstructor( queryContext:QueryContextBuilder, property:QueryProperty ) {\n\t\tthis._context = queryContext;\n\n\t\tproperty._builder = this;\n\t\tthis._document = property;\n\n\t\tthis._typesTriple = new SubjectToken( property.variable ).addPredicate( new PredicateToken( \"a\" ) );\n\t\tthis._values = new ValuesToken().addValues( property.variable );\n\n\t\tthis._schema = this._context.getGeneralSchema();\n\t}\n\n\tproperty( name?:string ):QueryProperty {\n\t\tif( name === void 0 ) return this._document;\n\n\t\tlet parent:string = this._document.name;\n\t\twhile( parent ) {\n\t\t\tconst fullPath:string = `${ parent }.${ name }`;\n\n\t\t\tif( this._context.hasProperty( fullPath ) ) return this._context.getProperty( fullPath );\n\n\t\t\tconst directPath:string = _getParentPath( fullPath );\n\t\t\tif( this._context.hasProperty( directPath ) ) {\n\t\t\t\tconst direct:QueryProperty = this._context.getProperty( directPath );\n\t\t\t\tconst directType:QueryPropertyType = direct.getType();\n\t\t\t\tif( directType === QueryPropertyType.FULL || directType === QueryPropertyType.ALL ) {\n\t\t\t\t\tconst propertyName:string = fullPath.substr( directPath.length + 1 );\n\t\t\t\t\treturn direct._builder._addProperty( propertyName, INHERIT );\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tparent = _getParentPath( parent );\n\t\t}\n\n\t\tthrow new IllegalArgumentError( `The \"${ name }\" property was not declared.` );\n\t}\n\n\tvalue( value:string | number | boolean | Date ):QueryValue {\n\t\treturn new QueryValue( this._context, value );\n\t}\n\n\tobject( object:Pointer | string ):QueryObject {\n\t\treturn new QueryObject( this._context, object );\n\t}\n\n\twithType( type:string ):this {\n\t\tif( this._context.hasProperties( this._document.name ) ) throw new IllegalStateError( \"Types must be specified before the properties.\" );\n\n\t\ttype = this._schema.resolveURI( type, { vocab: true } );\n\t\tif( ! this._typesTriple.predicates[ 0 ].objects.length )\n\t\t\tthis._document.addPattern( this._typesTriple );\n\n\t\tthis._typesTriple.predicates[ 0 ].addObject( this._context.compactIRI( type ) );\n\n\t\tif( ! this._context.context ) return this;\n\n\t\tif( this._context.context.hasObjectSchema( type ) )\n\t\t\tObjectSchemaDigester._combineSchemas( [\n\t\t\t\tthis._schema,\n\t\t\t\tthis._context.context.getObjectSchema( type ),\n\t\t\t] );\n\n\t\treturn this;\n\t}\n\n\tproperties( propertiesSchema:QuerySchema ):this {\n\t\tif( propertiesSchema === QueryDocumentBuilder.ALL ) {\n\t\t\tthis._document.setType( QueryPropertyType.ALL );\n\t\t\treturn this;\n\t\t}\n\n\t\tfor( const propertyName in propertiesSchema ) {\n\t\t\tconst queryPropertySchema:QuerySchemaProperty | string = propertiesSchema[ propertyName ];\n\t\t\tconst propertyDefinition:QuerySchemaProperty = isObject( queryPropertySchema ) ? queryPropertySchema : { \"@id\": queryPropertySchema };\n\n\t\t\tthis._addProperty( propertyName, propertyDefinition );\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tfilter( constraint:string ):this {\n\t\tconst [ baseName ]:string[] = this._document.name.split( \".\" );\n\t\tthis._context\n\t\t\t.getProperty( baseName )\n\t\t\t.addPattern( new FilterToken( constraint ) );\n\n\t\treturn this;\n\t}\n\n\tvalues( ...values:(QueryValue | QueryObject)[] ):this {\n\t\tconst termTokens:(LiteralToken | IRIToken | PrefixedNameToken)[] = values.map( value => {\n\t\t\tconst token:TermToken = value.getToken();\n\t\t\tif( token.token === \"blankNode\" ) throw new IllegalArgumentError( `Blank node \"${ token.label }\" is not a valid value.` );\n\n\t\t\treturn token;\n\t\t} );\n\n\t\tif( ! this._values.values[ 0 ].length ) this._document.addPattern( this._values );\n\t\tthis._values.values[ 0 ].push( ...termTokens );\n\n\t\tlet property:QueryProperty = this._document;\n\t\twhile( property.isOptional() ) {\n\t\t\tproperty.setOptional( false );\n\n\t\t\tconst parentPath:string = _getParentPath( property.name );\n\t\t\tproperty = this._context.getProperty( parentPath );\n\t\t}\n\n\t\treturn this;\n\t}\n\n\t_addProperty( propertyName:string, propertyDefinition:QuerySchemaProperty ):QueryProperty {\n\t\tconst digestedDefinition:DigestedObjectSchemaProperty = this.__addPropertyDefinition( propertyName, propertyDefinition );\n\t\tconst name:string = `${ this._document.name }.${ propertyName }`;\n\n\t\tconst property:QueryProperty = this._context\n\t\t\t.addProperty( name )\n\t\t\t.addPattern( ..._createPropertyPatterns(\n\t\t\t\tthis._context,\n\t\t\t\tthis._document.name,\n\t\t\t\tname,\n\t\t\t\tdigestedDefinition\n\t\t\t) );\n\n\t\tif( \"query\" in propertyDefinition ) {\n\t\t\tif( digestedDefinition.literal === false ) {\n\t\t\t\tproperty.setType( QueryPropertyType.PARTIAL );\n\t\t\t}\n\n\t\t\tconst builder:QueryDocumentBuilder = new QueryDocumentBuilder( this._context, property );\n\t\t\tif( builder !== propertyDefinition[ \"query\" ].call( void 0, builder ) )\n\t\t\t\tthrow new IllegalArgumentError( \"The provided query builder was not returned\" );\n\t\t}\n\n\t\tthis._document.addPattern( ...property.getPatterns() );\n\n\t\treturn property;\n\t}\n\n\tprivate __addPropertyDefinition( propertyName:string, propertyDefinition:ObjectSchemaProperty ):DigestedObjectSchemaProperty {\n\t\tconst digestedDefinition:DigestedObjectSchemaProperty = ObjectSchemaDigester.digestProperty( propertyName, propertyDefinition, this._schema );\n\n\t\tconst uri:string = \"@id\" in propertyDefinition ? digestedDefinition.uri : void 0;\n\t\tconst inheritDefinition:DigestedObjectSchemaProperty = this._context.getInheritTypeDefinition( this._schema, propertyName, uri );\n\t\tif( inheritDefinition ) {\n\t\t\tfor( const key in inheritDefinition ) {\n\t\t\t\tif( digestedDefinition[ key ] !== null && key !== \"uri\" ) continue;\n\t\t\t\tdigestedDefinition[ key ] = inheritDefinition[ key ];\n\t\t\t}\n\t\t}\n\n\t\tif( ! digestedDefinition.uri ) throw new IllegalArgumentError( `Invalid property \"${ propertyName }\" definition, \"@id\" is necessary.` );\n\n\t\tthis._document.getSchema()\n\t\t\t.properties.set( propertyName, digestedDefinition );\n\t\treturn digestedDefinition;\n\t}\n\n}\n"]}