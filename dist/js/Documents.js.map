{"version":3,"sources":["Documents.ts"],"names":["parse","expand","Documents","Documents.constructor","Documents.get","Documents.save","Documents.delete","Documents.getRDFDocument","Documents.injectDefinitions"],"mappings":"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","file":"Documents.js","sourcesContent":["/// <reference path=\"../typings/tsd.d.ts\" />\n\nimport * as jsonld from \"jsonld\";\n\nimport Committer from \"./Committer\";\nimport * as Errors from \"./Errors\";\nimport * as HTTP from \"./HTTP\";\nimport Context from \"./Context\";\nimport * as RDF from \"./RDF\";\nimport * as Utils from \"./Utils\";\n\nimport * as Document from \"./Document\";\nimport * as PersistedDocument from \"./PersistedDocument\";\n\nimport * as LDP from \"./NS/LDP\";\n\nfunction parse( input:string ):any {\n\ttry {\n\t\treturn JSON.parse( input );\n\t} catch ( error ) {\n\t\t// TODO: Handle SyntaxError\n\t\tthrow error;\n\t}\n}\n\nfunction expand( input:HTTP.ProcessedResponse<any>, options?:jsonld.ExpandOptions ):Promise<Object> {\n\treturn new Promise( ( resolve:( result:Object ) => void, reject:( error:any ) => void ) => {\n\t\tjsonld.expand( input.result, options, function ( error:any, expanded:Object ):void {\n\t\t\tif ( error ) {\n\t\t\t\t// TODO: Handle jsonld.expand error\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\tinput.result = expanded;\n\t\t\tresolve( input );\n\t\t} );\n\t} );\n}\n\nclass Documents {\n\tprivate context:Context;\n\n\tconstructor( context:Context ) {\n\t\tthis.context = context;\n\t}\n\n\tget( uri:string, requestOptions:HTTP.Request.Options = {} ):Promise<HTTP.ProcessedResponse<PersistedDocument.Class>> {\n\t\tif ( RDF.URI.Util.isRelative( uri ) ) {\n\t\t\tif ( ! this.context ) throw new Errors.IllegalArgumentError( \"IllegalArgument: This module doesn't support relative URIs.\" );\n\t\t\turi = this.context.resolve( uri );\n\t\t}\n\n\t\tif ( this.context && this.context.Auth.isAuthenticated() ) this.context.Auth.addAuthentication( requestOptions );\n\n\t\tHTTP.Request.Util.setAcceptHeader( \"application/ld+json\", requestOptions );\n\t\tHTTP.Request.Util.setPreferredInteractionModel( LDP.Class.RDFSource, requestOptions );\n\n\t\treturn HTTP.Request.Service.get( uri, requestOptions ).then(\n\t\t\t( response:HTTP.Response.Class ) => {\n\t\t\t\tlet parsedObject:Object = parse( response.data );\n\n\t\t\t\treturn expand( {\n\t\t\t\t\tresult: parsedObject,\n\t\t\t\t\tresponse: response,\n\t\t\t\t} );\n\t\t\t}\n\t\t).then(\n\t\t\t( processedResponse:HTTP.ProcessedResponse<Object> ) => {\n\t\t\t\tlet expandedResult:any = processedResponse.result;\n\t\t\t\tlet rdfDocuments:RDF.Document.Class[] = RDF.Document.Util.getDocuments( expandedResult );\n\t\t\t\tlet rdfDocument:RDF.Document.Class = this.getRDFDocument( rdfDocuments, processedResponse.response );\n\n\t\t\t\tlet document:Document.Class = Document.factory.from( rdfDocument );\n\n\t\t\t\tthis.injectDefinitions( (<RDF.Resource.Class[]>document.getFragments()).concat( document ) );\n\n\t\t\t\treturn {\n\t\t\t\t\tresult: document,\n\t\t\t\t\tresponse: processedResponse.response,\n\t\t\t\t};\n\t\t\t}\n\t\t).then(\n\t\t\t( processedResponse:HTTP.ProcessedResponse<Document.Class> ) => {\n\t\t\t\tlet document:Document.Class = processedResponse.result;\n\n\t\t\t\tlet persistedDocument:PersistedDocument.Class = PersistedDocument.Factory.from( document, this.context );\n\n\t\t\t\tlet etag:string = HTTP.Response.Util.getETag( processedResponse.response );\n\t\t\t\tif( etag === null ) throw new HTTP.Errors.BadResponseError( \"The response doesn't contain an ETag\", processedResponse.response );\n\n\t\t\t\tpersistedDocument._etag = etag;\n\n\t\t\t\t// TODO: Inject persisted container behavior\n\n\t\t\t\treturn {\n\t\t\t\t\tresult: persistedDocument,\n\t\t\t\t\tresponse: processedResponse.response,\n\t\t\t\t};\n\t\t\t}\n\t\t);\n\t}\n\n\tsave( persistedDocument:PersistedDocument.Class, requestOptions:HTTP.Request.Options = {} ):Promise<HTTP.Response.Class> {\n\t\tif( ! persistedDocument.isDirty() ) return new Promise<HTTP.Response.Class>( ( resolve:( result:HTTP.Response.Class ) => void ) => {\n\t\t\tresolve( null );\n\t\t});\n\n\t\tif ( this.context && this.context.Auth.isAuthenticated() ) this.context.Auth.addAuthentication( requestOptions );\n\n\t\tHTTP.Request.Util.setAcceptHeader( \"application/ld+json\", requestOptions );\n\t\tHTTP.Request.Util.setContentTypeHeader( \"application/ld+json\", requestOptions );\n\t\tHTTP.Request.Util.setPreferredInteractionModel( LDP.Class.RDFSource, requestOptions );\n\t\tHTTP.Request.Util.setIfMatchHeader( persistedDocument._etag, requestOptions );\n\n\t\treturn HTTP.Request.Service.put( persistedDocument.uri, persistedDocument.toJSON(), requestOptions );\n\t}\n\n\tdelete( persistedDocument:PersistedDocument.Class, requestOptions:HTTP.Request.Options = {} ):Promise<HTTP.Response.Class> {\n\t\tif ( this.context && this.context.Auth.isAuthenticated() ) this.context.Auth.addAuthentication( requestOptions );\n\n\t\tHTTP.Request.Util.setAcceptHeader( \"application/ld+json\", requestOptions );\n\t\tHTTP.Request.Util.setPreferredInteractionModel( LDP.Class.RDFSource, requestOptions );\n\t\tHTTP.Request.Util.setIfMatchHeader( persistedDocument._etag, requestOptions );\n\n\t\treturn HTTP.Request.Service.delete( persistedDocument.uri, persistedDocument.toJSON(), requestOptions );\n\t}\n\n\tprivate getRDFDocument( rdfDocuments:RDF.Document.Class[], response:HTTP.Response.Class ):RDF.Document.Class {\n\t\tif ( rdfDocuments.length === 0 ) throw new HTTP.Errors.BadResponseError( \"No document was returned.\", response );\n\t\tif ( rdfDocuments.length > 1 ) throw new Error( \"Unsupported: Multiple graphs are currently not supported.\" );\n\t\treturn rdfDocuments[ 0 ];\n\t}\n\n\tprivate injectDefinitions( resources:RDF.Resource.Class[] ):RDF.Resource.Class[] {\n\t\tlet definitionURIs:string[] = this.context.getDefinitionURIs();\n\n\t\tfor ( let i:number = 0, length:number = definitionURIs.length; i < length; i ++ ) {\n\t\t\tlet definitionURI:string = definitionURIs[ i ];\n\t\t\tlet toInject:RDF.Resource.Class[] = [];\n\t\t\tfor ( let j:number = 0, resourcesLength:number = resources.length; j < resourcesLength; j ++ ) {\n\t\t\t\tlet resource:RDF.Resource.Class = resources[ j ];\n\t\t\t\tif ( resource.types.indexOf( definitionURI ) !== - 1 ) toInject.push( resource );\n\t\t\t}\n\t\t\tif ( toInject.length > 0 ) RDF.Resource.Factory.injectDescriptions( toInject, this.context.getDefinition( definitionURI ) );\n\t\t}\n\n\t\treturn resources;\n\t}\n}\n\nexport default Documents;\n"],"sourceRoot":"/source/"}